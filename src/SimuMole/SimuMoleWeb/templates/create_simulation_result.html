{% extends "base.html" %}

{% block content %}

    <style>
        #simulation_status {
            font-weight: bold;
        }

        #simulation_status_during_run {
            white-space: pre;
        }
    </style>


    <title>Create Simulation - SimuMole</title>

    <h1><strong>Create Your Simulation</strong></h1><br>


    <h3>The status of your request:</h3>
    <p id="simulation_status"> Processing your parameters...</p>
    <p id="simulation_status_during_run"></p>

    {# this section appears only after the simulation is ready    #}
    <div id="simulation_is_ready">

        <div>
            <br>
            <h3>Download pdb, dcd files and the OpenMM script:</h3>
            <a href="/media/files/dcd_pdbs_openmm.zip">Link to download zip file</a>
        </div>

        <div>
            <br>
            <h3>Get the files by email:</h3>
            <p> complete later...</p>
        </div>

        <div>
            <br>
            <h3>Create the animation:</h3>
            <p> complete later...</p>
        </div>

    </div>

    {#    <h3>Your input parameters:</h3>#}
    {#    <ul>#}
    {#        {% for key, value in form_data.items %}#}
    {#            <li><strong>{{ key }}</strong> - {{ value }}</li>#}
    {#        {% endfor %}#}
    {#    </ul>#}


{% endblock %}

{% block extra_js %}
    <script>

        hide_results(); // hide "simulation_is_ready" section as default

        const interval = setInterval(function () {
            update_simulation_status_()
        }, 4000); // unit of milliseconds

        function update_simulation_status_() {
            $.ajax({
                url: '{% url 'update_simulation_status' %}',
                type: "get",
                cache: true,
                timeout: 30000,
                dataType: 'json',
                success: function (data) {

                    // simulation_status:
                    if (data['simulation_status'] !== "") {
                        document.getElementById('simulation_status').textContent = data['simulation_status'];
                        if (data['simulation_status'] === "Done!") {
                            clearInterval(interval);
                            show_results()
                        }
                    }

                    // simulation_status_during_run:
                    if (data['simulation_status'] === "Running simulation..." && data['simulation_status_during_run'] !== "") {
                        const simulation_status_during_run = data['simulation_status_during_run'].split(',');
                        const progress = simulation_status_during_run[0];
                        const remainingTime = simulation_status_during_run[1];
                        document.getElementById('simulation_status_during_run').textContent =
                            'Progress: ' + progress + '\r\n' + 'Remaining Time: ' + remainingTime;
                    } else {
                        document.getElementById('simulation_status_during_run').textContent = ''
                    }

                },
            });
        }

        function show_results() {
            if (document.getElementById('simulation_is_ready')) {
                change_visibility_of_element("simulation_is_ready", '', '');
            }
        }

        function hide_results() {
            if (document.getElementById('simulation_is_ready')) {
                change_visibility_of_element("simulation_is_ready", 'hidden', 'none');
            }
        }

        function change_visibility_of_element(element_id, visibility = '', display = '') {
            let element = document.getElementById(element_id);
            element.style.visibility = visibility;      // visibility = 'hidden' or ''
            element.style.display = display;            // display = 'none' or ''
        }

    </script>
{% endblock extra_js %}